name: iOS TestFlight Deploy

on:
  workflow_dispatch:
    inputs:
      distribute_external:
        description: 'Distribute to external testers'
        required: false
        default: 'false'
        type: boolean
  push:
    tags:
      - 'ios-v*'

env:
  XCODE_VERSION: '16.0'

jobs:
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./ios

      - name: Install Fastlane
        working-directory: ./ios
        run: bundle install

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: ./ios/AllowanceTracker
        run: xcodegen generate

      - name: Setup App Store Connect API Key
        working-directory: ./ios
        run: |
          mkdir -p fastlane
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 --decode > fastlane/AuthKey.p8

      - name: Setup Match certificates
        working-directory: ./ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PATH: ./fastlane/AuthKey.p8
        run: bundle exec fastlane sync_appstore_certs

      - name: Build and upload to TestFlight
        working-directory: ./ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PATH: ./fastlane/AuthKey.p8
          DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ "${{ github.event.inputs.distribute_external }}" == "true" ]; then
            bundle exec fastlane beta_external
          else
            bundle exec fastlane beta
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-ipa
          path: ./ios/build/*.ipa

      - name: Clean up sensitive files
        if: always()
        run: rm -f ./ios/fastlane/AuthKey.p8
